<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metal Tracker - Edelmetall Portfolio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .gold-text { color: #FFD700; }
        .silver-text { color: #C0C0C0; }
        .platinum-text { color: #E5E4E2; }
        .palladium-text { color: #CED0DD; }
        .positive { color: #10B981; }
        .negative { color: #EF4444; }
        .gold-bg { background: linear-gradient(135deg, #FFD700 0%, #B8860B 100%); }
        .silver-bg { background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%); }
        select, input { color: #fff; }
        select option { background: #1f2937; color: #fff; }

        /* Date-Input Styling - OS-Standard nutzen, aber konsistentes Aussehen */
        input[type="date"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            min-height: 38px;
            cursor: pointer;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
            opacity: 0.6;
        }
        input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        /* Modal-Animationen */
        .modal-content {
            animation: modalSlideIn 0.2s ease-out;
        }
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Mobile Card Layout für Positionen */
        @media (max-width: 767px) {
            .positions-table-desktop { display: none; }
            .positions-cards-mobile { display: block; }
        }
        @media (min-width: 768px) {
            .positions-table-desktop { display: block; }
            .positions-cards-mobile { display: none; }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-5xl">

        <!-- Header -->
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
            <div>
                <h1 class="text-2xl font-bold gold-text">Metal Tracker</h1>
                <p class="text-gray-400 text-sm">Dein Edelmetall-Portfolio</p>
            </div>
            <div class="flex items-center gap-2 sm:gap-4 w-full sm:w-auto">
                <div class="text-right text-xs sm:text-sm text-gray-500 hidden sm:block">
                    <span id="last-update">-</span>
                </div>
                <!-- User Menu -->
                <div class="relative flex-1 sm:flex-initial" id="user-menu">
                    <button onclick="toggleUserMenu()" class="flex items-center gap-2 bg-gray-800 hover:bg-gray-700 px-2 sm:px-3 py-2 rounded-lg transition w-full sm:w-auto justify-between">
                        <span id="user-email" class="text-xs sm:text-sm text-gray-300 truncate max-w-[100px] sm:max-w-[150px]">-</span>
                        <span id="tier-badge" class="text-xs px-2 py-0.5 rounded bg-gray-600 text-gray-300 whitespace-nowrap">free</span>
                        <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                        </svg>
                    </button>
                    <div id="user-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-xl border border-gray-700 z-50">
                        <div class="px-4 py-3 border-b border-gray-700">
                            <p class="text-xs text-gray-500">E-Mail</p>
                            <p class="text-sm break-all mb-2" id="user-email-full">-</p>
                            <p class="text-xs text-gray-500">Positionen</p>
                            <p class="text-sm"><span id="positions-used">0</span> / <span id="positions-limit">10</span></p>
                        </div>
                        <button onclick="showSettingsModal()" class="w-full text-left px-4 py-3 text-sm text-gray-300 hover:bg-gray-700 transition">
                            Einstellungen
                        </button>
                        <button onclick="logout()" class="w-full text-left px-4 py-3 text-sm text-red-400 hover:bg-gray-700 rounded-b-lg transition">
                            Abmelden
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Upgrade Banner (nur für Free-User) -->
        <div id="upgrade-banner" class="hidden mb-4 bg-gradient-to-r from-yellow-600/20 to-yellow-500/10 border border-yellow-600/30 rounded-lg p-4 flex justify-between items-center">
            <div>
                <p class="text-yellow-500 font-medium">Position-Limit fast erreicht!</p>
                <p class="text-sm text-gray-400">Upgrade auf Premium für unbegrenzte Positionen.</p>
            </div>
            <button class="hidden bg-yellow-600 hover:bg-yellow-500 text-black font-bold px-4 py-2 rounded text-sm transition">
                Upgrade
            </button>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
            <div class="bg-gray-800 rounded-lg p-4 border-l-4 border-gray-600">
                <p class="text-gray-400 text-xs uppercase tracking-wide">Kaufwert</p>
                <p id="total-purchase" class="text-xl font-bold mt-1">-</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border-l-4 border-yellow-500">
                <p class="text-gray-400 text-xs uppercase tracking-wide">Ankaufswert</p>
                <p id="total-current" class="text-xl font-bold mt-1">-</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border-l-4 border-green-500">
                <p class="text-gray-400 text-xs uppercase tracking-wide">Gewinn/Verlust</p>
                <p id="total-profit" class="text-xl font-bold mt-1">-</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-4 border-l-4 border-blue-500">
                <p class="text-gray-400 text-xs uppercase tracking-wide">Rendite</p>
                <p id="total-percent" class="text-xl font-bold mt-1">-</p>
            </div>
        </div>

        <!-- Chart & Preise -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
            <!-- Verlauf Chart -->
            <div class="lg:col-span-2 bg-gray-800 rounded-lg p-4">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-semibold">Portfolio-Verlauf</h2>
                    <select id="chart-period" class="bg-gray-700 rounded px-2 py-1 text-sm">
                        <option value="7">7 Tage</option>
                        <option value="30" selected>30 Tage</option>
                        <option value="90">90 Tage</option>
                        <option value="365">1 Jahr</option>
                    </select>
                </div>
                <div class="h-48">
                    <canvas id="history-chart"></canvas>
                </div>
                <p id="no-history" class="text-gray-500 text-sm text-center py-8 hidden">
                    Noch keine Verlaufsdaten. Erstelle Positionen um den Verlauf zu sehen.
                </p>
            </div>

            <!-- Aktuelle Preise -->
            <div class="bg-gray-800 rounded-lg p-4">
                <h2 class="font-semibold mb-3">Ankaufspreise</h2>
                <div class="space-y-3">
                    <div class="flex justify-between items-center">
                        <span class="gold-text font-medium">Gold</span>
                        <div class="text-right">
                            <span id="price-gold-g" class="text-sm">-</span>
                            <span class="text-gray-500 text-xs block" id="price-gold-oz">-</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="silver-text font-medium">Silber</span>
                        <div class="text-right">
                            <span id="price-silver-g" class="text-sm">-</span>
                            <span class="text-gray-500 text-xs block" id="price-silver-oz">-</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="platinum-text font-medium">Platin</span>
                        <div class="text-right">
                            <span id="price-platinum-g" class="text-sm">-</span>
                            <span class="text-gray-500 text-xs block" id="price-platinum-oz">-</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="palladium-text font-medium">Palladium</span>
                        <div class="text-right">
                            <span id="price-palladium-g" class="text-sm">-</span>
                            <span class="text-gray-500 text-xs block" id="price-palladium-oz">-</span>
                        </div>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-3 pt-3 border-t border-gray-700">
                    Quelle: GOLD.DE (Spot-Preise)
                </p>
            </div>
        </div>

        <!-- Positionen Tabelle -->
        <div class="bg-gray-800 rounded-lg p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-semibold">Positionen</h2>
                <span id="positions-count" class="text-gray-400 text-sm">0 Positionen</span>
            </div>

            <!-- Desktop: Tabelle -->
            <div class="overflow-x-auto positions-table-desktop">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="text-gray-400 text-xs uppercase border-b border-gray-700">
                            <th class="text-left py-2 px-1">Metall</th>
                            <th class="text-left py-2 px-1">Kategorie</th>
                            <th class="text-left py-2 px-1">Beschreibung</th>
                            <th class="text-right py-2 px-1">Anz.</th>
                            <th class="text-right py-2 px-1">Gewicht</th>
                            <th class="text-right py-2 px-1">Kaufdatum</th>
                            <th class="text-right py-2 px-1">Kaufpreis</th>
                            <th class="text-right py-2 px-1">Ankauf</th>
                            <th class="text-right py-2 px-1">+/-</th>
                            <th class="text-center py-2 px-1"></th>
                        </tr>
                    </thead>
                    <tbody id="positions-table">
                        <tr><td colspan="10" class="text-center py-8 text-gray-500">Lade Positionen...</td></tr>
                    </tbody>
                </table>
            </div>

            <!-- Mobile: Cards -->
            <div id="positions-cards" class="positions-cards-mobile space-y-3">
                <p class="text-center py-8 text-gray-500">Lade Positionen...</p>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-6 pb-16 text-center text-gray-600 text-xs">
            <p>Preise von GOLD.DE - ohne Gewähr</p>
        </footer>
    </div>

    <!-- Floating Action Button (FAB) -->
    <button onclick="showAddPositionModal()"
            class="fixed bottom-6 right-6 w-14 h-14 bg-yellow-600 hover:bg-yellow-500 text-black rounded-full shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center z-40 hover:scale-110"
            title="Neue Position hinzufügen">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/>
        </svg>
    </button>

    <!-- Modal: Neue Position -->
    <div id="add-position-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-gray-800 rounded-xl p-5 max-w-md w-full shadow-2xl max-h-[90vh] overflow-y-auto border border-gray-700/50">
            <div class="flex justify-between items-center mb-5 pb-3 border-b border-gray-700/50">
                <h3 class="text-lg font-semibold">Neue Position</h3>
                <button onclick="hideAddPositionModal()" class="text-gray-400 hover:text-white transition p-1 hover:bg-gray-700 rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <form id="add-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1.5">Metall</label>
                        <select id="metal-type" onchange="updateSpreadReference()" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none">
                            <option value="gold">Gold</option>
                            <option value="silver">Silber</option>
                            <option value="platinum">Platin</option>
                            <option value="palladium">Palladium</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1.5">Kategorie</label>
                        <select id="spread-category" onchange="updateSpreadReference()" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none">
                            <optgroup label="Muenzen">
                                <option value="coin_bullion">Bullion-Muenze</option>
                                <option value="coin_numismatic">Sammlermuenze</option>
                            </optgroup>
                            <optgroup label="Barren">
                                <option value="bar_large" selected>Barren (ab 100g)</option>
                                <option value="bar_small">Barren (unter 100g)</option>
                                <option value="bar_minted">Praege-Barren</option>
                            </optgroup>
                            <optgroup label="Sonstiges">
                                <option value="round">Medaille/Round</option>
                                <option value="granulate">Granulat</option>
                                <option value="jewelry">Schmuck</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs text-gray-400 mb-1.5">Beschreibung</label>
                    <input type="text" id="description" placeholder="z.B. Krügerrand 1oz"
                           class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none placeholder-gray-500">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1.5">Anzahl</label>
                        <input type="number" id="quantity" value="1" min="1" step="1" required
                               class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1.5">Gewicht pro Stück</label>
                        <div class="flex">
                            <input type="number" id="weight" step="0.001" min="0" value="1" required
                                   class="w-full bg-gray-700 border border-gray-600 border-r-0 rounded-l-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none">
                            <select id="weight-unit" class="bg-gray-600 border border-gray-600 rounded-r-lg px-2 py-2.5 text-sm focus:outline-none min-w-[52px]">
                                <option value="oz">oz</option>
                                <option value="g">g</option>
                                <option value="kg">kg</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-1.5">Kaufpreis (EUR)</label>
                        <input type="number" id="purchase-price" step="0.01" min="0" required placeholder="0,00"
                               class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none placeholder-gray-500">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-400 mb-1.5">Kaufdatum</label>
                        <input type="date" id="purchase-date"
                               class="w-full bg-gray-700 border border-gray-600 rounded-lg px-3 py-2.5 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none">
                    </div>
                </div>
                <div class="bg-gray-700/50 rounded-lg p-3 border border-gray-600/50">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs text-gray-400">Ankaufsabschlag</label>
                        <span id="spread-reference" class="text-xs text-gray-500">Markt: ~3%</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="use-custom-spread" onchange="toggleCustomSpread()" class="rounded bg-gray-600 border-gray-500 text-yellow-500 focus:ring-yellow-500">
                        <label for="use-custom-spread" class="text-sm text-gray-300">Eigenen Wert verwenden</label>
                    </div>
                    <input type="number" id="spread-percent" step="0.1" min="0" max="100" placeholder="z.B. 5"
                           class="hidden w-full bg-gray-600 border border-gray-500 rounded-lg px-3 py-2 text-sm mt-2 focus:ring-2 focus:ring-yellow-500 focus:border-transparent focus:outline-none placeholder-gray-400"
                           title="Ankaufsabschlag in % (was ein Haendler typischerweise unter Spot zahlt)">
                    <p class="text-xs text-gray-500 mt-2">Der Ankaufsabschlag wird aus deinen Einstellungen geholt, falls kein eigener Wert angegeben wird.</p>
                </div>
                <div class="flex gap-3 pt-3">
                    <button type="button" onclick="hideAddPositionModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-gray-200 font-medium py-2.5 rounded-lg transition border border-gray-600">
                        Abbrechen
                    </button>
                    <button type="submit"
                            class="flex-1 bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-2.5 rounded-lg transition">
                        Hinzufügen
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Neuen API-Key erstellen -->
    <div id="create-key-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 shadow-xl">
            <h3 class="text-lg font-semibold mb-4">Neuer API-Key</h3>
            <input type="text" id="key-name-input" placeholder="Name (z.B. Mein Script)" maxlength="100"
                   class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-3 text-white focus:ring-2 focus:ring-yellow-500 focus:outline-none mb-4">
            <div class="flex gap-3">
                <button onclick="hideCreateKeyModal()" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-medium py-2 rounded transition">
                    Abbrechen
                </button>
                <button onclick="createApiKey()" class="flex-1 bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-2 rounded transition">
                    Erstellen
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: API-Key anzeigen (nur einmal!) -->
    <div id="show-key-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 max-w-lg w-full mx-4 shadow-xl">
            <h3 class="text-lg font-semibold mb-2">API-Key erstellt</h3>
            <p class="text-yellow-500 text-sm mb-4">Kopiere diesen Key jetzt - er wird nicht erneut angezeigt!</p>
            <div class="bg-gray-900 rounded p-3 mb-4 flex items-center gap-2">
                <code id="new-api-key" class="flex-1 text-sm break-all text-green-400"></code>
                <button onclick="copyApiKey()" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm transition" title="Kopieren">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                    </svg>
                </button>
            </div>
            <p class="text-gray-400 text-xs mb-4">
                Verwendung: <code class="bg-gray-900 px-1 rounded">curl -H "X-API-Key: mt_..."</code>
            </p>
            <button onclick="hideShowKeyModal()" class="w-full bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-2 rounded transition">
                Verstanden
            </button>
        </div>
    </div>

    <!-- Modal: Einstellungen (mit Tabs) -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg max-w-lg w-full mx-4 shadow-xl max-h-[90vh] overflow-hidden flex flex-col">
            <!-- Header mit Tabs -->
            <div class="border-b border-gray-700">
                <div class="flex justify-between items-center px-6 pt-4 pb-0">
                    <h3 class="text-lg font-semibold">Einstellungen</h3>
                    <button onclick="hideSettingsModal()" class="text-gray-400 hover:text-white transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <div class="flex px-6 mt-4">
                    <button onclick="showSettingsTab('discounts')" id="tab-discounts" class="px-4 py-2 text-sm font-medium border-b-2 border-yellow-500 text-yellow-500 transition">
                        Ankaufsabschlaege
                    </button>
                    <button onclick="showSettingsTab('apikeys')" id="tab-apikeys" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-200 transition">
                        API-Keys
                    </button>
                </div>
            </div>

            <!-- Tab Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <!-- Spreads Tab -->
                <div id="settings-discounts" class="space-y-4">
                    <p class="text-gray-400 text-sm">Standard-Ankaufsabschlaege pro Kategorie (in %). Diese werden verwendet, wenn eine Position keinen eigenen Abschlag hat.</p>

                    <!-- Muenzen -->
                    <div class="bg-gray-700/30 rounded-lg p-3">
                        <h4 class="text-sm font-medium text-yellow-500 mb-2">Muenzen</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Bullion-Muenze</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="spread-coin_bullion" step="0.1" min="0" max="100" placeholder="3"
                                           class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-white text-sm focus:ring-2 focus:ring-yellow-500 focus:outline-none">
                                    <span class="text-xs text-gray-500 whitespace-nowrap">~3%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Sammlermuenze</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="spread-coin_numismatic" step="0.1" min="0" max="100" placeholder="8"
                                           class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-white text-sm focus:ring-2 focus:ring-yellow-500 focus:outline-none">
                                    <span class="text-xs text-gray-500 whitespace-nowrap">~8%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Barren -->
                    <div class="bg-gray-700/30 rounded-lg p-3">
                        <h4 class="text-sm font-medium text-yellow-500 mb-2">Barren</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Gross (ab 100g)</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="spread-bar_large" step="0.1" min="0" max="100" placeholder="2"
                                           class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-white text-sm focus:ring-2 focus:ring-yellow-500 focus:outline-none">
                                    <span class="text-xs text-gray-500 whitespace-nowrap">~2%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Klein (unter 100g)</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="spread-bar_small" step="0.1" min="0" max="100" placeholder="4"
                                           class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-white text-sm focus:ring-2 focus:ring-yellow-500 focus:outline-none">
                                    <span class="text-xs text-gray-500 whitespace-nowrap">~4%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Praege-Barren</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="spread-bar_minted" step="0.1" min="0" max="100" placeholder="3.5"
                                           class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-white text-sm focus:ring-2 focus:ring-yellow-500 focus:outline-none">
                                    <span class="text-xs text-gray-500 whitespace-nowrap">~3.5%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sonstiges -->
                    <div class="bg-gray-700/30 rounded-lg p-3">
                        <h4 class="text-sm font-medium text-yellow-500 mb-2">Sonstiges</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Medaille/Round</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="spread-round" step="0.1" min="0" max="100" placeholder="5"
                                           class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-white text-sm focus:ring-2 focus:ring-yellow-500 focus:outline-none">
                                    <span class="text-xs text-gray-500 whitespace-nowrap">~5%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Granulat</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="spread-granulate" step="0.1" min="0" max="100" placeholder="2"
                                           class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-white text-sm focus:ring-2 focus:ring-yellow-500 focus:outline-none">
                                    <span class="text-xs text-gray-500 whitespace-nowrap">~2%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-400 mb-1">Schmuck</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="spread-jewelry" step="0.1" min="0" max="100" placeholder="15"
                                           class="flex-1 bg-gray-700 border border-gray-600 rounded px-3 py-1.5 text-white text-sm focus:ring-2 focus:ring-yellow-500 focus:outline-none">
                                    <span class="text-xs text-gray-500 whitespace-nowrap">~15%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p class="text-xs text-gray-500">
                        Die Referenzwerte (~) sind typische Haendler-Ankaufswerte unter Spot-Preis fuer Gold. Silber hat hoehere Abschlaege.
                    </p>

                    <div class="flex gap-3">
                        <button onclick="resetSpreadsToDefault()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-gray-200 font-medium py-2.5 rounded transition border border-gray-600">
                            Zuruecksetzen
                        </button>
                        <button onclick="saveSettings()" class="flex-1 bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-2.5 rounded transition">
                            Speichern
                        </button>
                    </div>
                </div>

                <!-- API Keys Tab -->
                <div id="settings-apikeys" class="hidden space-y-4">
                    <div class="flex justify-between items-center">
                        <p class="text-gray-400 text-sm">API-Keys für programmatischen Zugriff</p>
                        <button onclick="showCreateKeyModal()" class="bg-yellow-600 hover:bg-yellow-500 text-black text-sm font-bold px-3 py-1.5 rounded transition">
                            + Neuer Key
                        </button>
                    </div>

                    <div id="api-keys-list" class="space-y-2">
                        <p class="text-gray-500 text-sm">Lade API-Keys...</p>
                    </div>

                    <div class="bg-gray-700/50 rounded p-3 mt-4">
                        <p class="text-xs text-gray-400 mb-2">Verwendung:</p>
                        <code class="text-xs text-green-400 break-all">curl -H "X-API-Key: mt_..." URL</code>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = '';
        let historyChart = null;
        let currentUser = null;

        // === JWT TOKEN MANAGEMENT ===
        function getToken() {
            return localStorage.getItem('metaltracker_token');
        }

        function removeToken() {
            localStorage.removeItem('metaltracker_token');
        }

        // Hilfsfunktion fuer API-Requests mit JWT Auth
        async function apiFetch(url, options = {}) {
            const token = getToken();
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            const headers = options.headers || {};
            headers['Authorization'] = 'Bearer ' + token;

            const response = await fetch(url, { ...options, headers });

            // Bei 401 -> Token ungueltig -> Logout
            if (response.status === 401) {
                removeToken();
                window.location.href = '/login.html';
                return;
            }

            return response;
        }

        // === USER MENU ===
        function toggleUserMenu() {
            document.getElementById('user-dropdown').classList.toggle('hidden');
        }

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('user-menu');
            if (menu && !menu.contains(e.target)) {
                document.getElementById('user-dropdown').classList.add('hidden');
            }
        });

        function logout() {
            removeToken();
            window.location.href = '/login.html';
        }

        // === LOAD USER INFO ===
        async function loadUserInfo() {
            try {
                const res = await apiFetch(API + '/api/auth/me');
                if (!res || !res.ok) return;

                currentUser = await res.json();

                // Update UI
                document.getElementById('user-email').textContent = currentUser.email;
                document.getElementById('user-email-full').textContent = currentUser.email;
                document.getElementById('tier-badge').textContent = currentUser.tier;

                if (currentUser.tier === 'premium') {
                    document.getElementById('tier-badge').classList.remove('bg-gray-600');
                    document.getElementById('tier-badge').classList.add('bg-yellow-600', 'text-black');
                }

                // Load tier info
                await loadTierInfo();
            } catch (e) {
                console.error('Fehler beim Laden der User-Info:', e);
            }
        }

        async function loadTierInfo() {
            try {
                const res = await apiFetch(API + '/api/auth/tier-info');
                if (!res || !res.ok) return;

                const tierInfo = await res.json();

                document.getElementById('positions-used').textContent = tierInfo.positions_count;
                document.getElementById('positions-limit').textContent = tierInfo.positions_limit;

                // Show upgrade banner if near limit (80%+) and not premium
                if (tierInfo.tier === 'free' && tierInfo.positions_count >= 8) {
                    document.getElementById('upgrade-banner').classList.remove('hidden');
                }
            } catch (e) {
                console.error('Fehler beim Laden der Tier-Info:', e);
            }
        }

        // === XSS-SCHUTZ ===
        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Formatierung
        const formatEUR = (val) => new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(val);
        const formatPercent = (val) => (val >= 0 ? '+' : '') + val.toFixed(2) + '%';
        const formatWeight = (val, unit) => {
            if (unit === 'oz') return val.toFixed(3) + ' oz';
            if (unit === 'kg') return val.toFixed(3) + ' kg';
            return val.toFixed(2) + ' g';
        };
        const formatDate = (d) => new Date(d).toLocaleDateString('de-DE');

        const metalNames = { gold: 'Gold', silver: 'Silber', platinum: 'Platin', palladium: 'Palladium' };
        const metalColors = { gold: 'gold-text', silver: 'silver-text', platinum: 'platinum-text', palladium: 'palladium-text' };
        const productNames = { coin: 'Muenze', bar: 'Barren', round: 'Medaille', granulate: 'Granulat', jewelry: 'Schmuck' };
        const spreadCategoryNames = {
            coin_bullion: 'Bullion-Muenze',
            coin_numismatic: 'Sammlermuenze',
            bar_large: 'Barren (gross)',
            bar_small: 'Barren (klein)',
            bar_minted: 'Praege-Barren',
            round: 'Medaille',
            granulate: 'Granulat',
            jewelry: 'Schmuck'
        };

        // Markt-Referenzwerte fuer Spreads (Gold als Basis)
        const REFERENCE_SPREADS = {
            gold: { coin_bullion: 3.0, coin_numismatic: 8.0, bar_large: 2.0, bar_small: 4.0, bar_minted: 3.5, round: 5.0, granulate: 2.0, jewelry: 15.0 },
            silver: { coin_bullion: 15.0, coin_numismatic: 20.0, bar_large: 12.0, bar_small: 18.0, bar_minted: 15.0, round: 18.0, granulate: 12.0, jewelry: 30.0 },
            platinum: { coin_bullion: 5.0, coin_numismatic: 10.0, bar_large: 4.0, bar_small: 6.0, bar_minted: 5.0, round: 8.0, granulate: 4.0, jewelry: 20.0 },
            palladium: { coin_bullion: 6.0, coin_numismatic: 12.0, bar_large: 5.0, bar_small: 7.0, bar_minted: 6.0, round: 10.0, granulate: 5.0, jewelry: 25.0 }
        };

        // Update der Referenz-Anzeige im Modal
        function updateSpreadReference() {
            const metal = document.getElementById('metal-type').value;
            const category = document.getElementById('spread-category').value;
            const refSpread = REFERENCE_SPREADS[metal]?.[category] || 5.0;
            document.getElementById('spread-reference').textContent = 'Markt: ~' + refSpread + '%';
        }

        function toggleCustomSpread() {
            const checkbox = document.getElementById('use-custom-spread');
            const input = document.getElementById('spread-percent');
            if (checkbox.checked) {
                input.classList.remove('hidden');
                input.focus();
            } else {
                input.classList.add('hidden');
                input.value = '';
            }
        }

        // Daten laden
        async function loadPrices() {
            try {
                const res = await fetch(API + '/api/prices');
                const data = await res.json();

                for (const [metal, info] of Object.entries(data.prices)) {
                    const gEl = document.getElementById('price-' + metal + '-g');
                    const ozEl = document.getElementById('price-' + metal + '-oz');
                    if (gEl) gEl.textContent = formatEUR(info.spot_per_gram_eur) + '/g';
                    if (ozEl) ozEl.textContent = formatEUR(info.spot_per_oz_eur) + '/oz';
                }

                document.getElementById('last-update').textContent =
                    'Update: ' + new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
            } catch (e) {
                console.error('Fehler beim Laden der Preise:', e);
            }
        }

        async function loadSummary() {
            try {
                const res = await apiFetch(API + '/api/summary');
                if (!res || !res.ok) return;
                const data = await res.json();

                document.getElementById('total-purchase').textContent = formatEUR(data.total_purchase_value_eur);
                document.getElementById('total-current').textContent = formatEUR(data.total_current_value_eur);

                const profitEl = document.getElementById('total-profit');
                profitEl.textContent = (data.total_profit_loss_eur >= 0 ? '+' : '') + formatEUR(data.total_profit_loss_eur);
                profitEl.className = 'text-xl font-bold mt-1 ' + (data.total_profit_loss_eur >= 0 ? 'positive' : 'negative');

                const percentEl = document.getElementById('total-percent');
                percentEl.textContent = formatPercent(data.total_profit_loss_percent);
                percentEl.className = 'text-xl font-bold mt-1 ' + (data.total_profit_loss_percent >= 0 ? 'positive' : 'negative');
            } catch (e) {
                console.error('Fehler beim Laden der Summary:', e);
            }
        }

        async function loadPositions() {
            try {
                const res = await apiFetch(API + '/api/positions');
                if (!res || !res.ok) return;
                const positions = await res.json();

                const tbody = document.getElementById('positions-table');
                const cardsContainer = document.getElementById('positions-cards');
                document.getElementById('positions-count').textContent = positions.length + ' Position' + (positions.length !== 1 ? 'en' : '');

                if (positions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" class="text-center py-8 text-gray-500">Keine Positionen vorhanden</td></tr>';
                    cardsContainer.innerHTML = '<p class="text-center py-8 text-gray-500">Keine Positionen vorhanden</p>';
                    return;
                }

                // Desktop: Tabelle
                tbody.innerHTML = positions.map(p => `
                    <tr class="border-b border-gray-700/50 hover:bg-gray-700/30">
                        <td class="py-3 px-1 ${metalColors[p.metal_type] || ''} font-medium">${escapeHtml(metalNames[p.metal_type] || p.metal_type)}</td>
                        <td class="py-3 px-1 text-gray-400 text-xs">${escapeHtml(spreadCategoryNames[p.spread_category] || productNames[p.product_type] || p.product_type)}</td>
                        <td class="py-3 px-1">${escapeHtml(p.description) || '-'}</td>
                        <td class="py-3 px-1 text-right">${parseInt(p.quantity)}x</td>
                        <td class="py-3 px-1 text-right font-mono text-xs">${p.quantity > 1 ? parseInt(p.quantity) + 'x ' : ''}${formatWeight(p.weight_per_unit, p.weight_unit)}</td>
                        <td class="py-3 px-1 text-right text-xs text-gray-400">${p.purchase_date ? formatDate(p.purchase_date) : '-'}</td>
                        <td class="py-3 px-1 text-right">${formatEUR(p.purchase_price_eur)}</td>
                        <td class="py-3 px-1 text-right font-medium" title="Spread: ${p.effective_spread_percent || 0}%">${formatEUR(p.current_value_eur)}</td>
                        <td class="py-3 px-1 text-right ${p.profit_loss_eur >= 0 ? 'positive' : 'negative'}">
                            ${(p.profit_loss_eur >= 0 ? '+' : '') + formatEUR(p.profit_loss_eur)}<br>
                            <span class="text-xs opacity-75">${formatPercent(p.profit_loss_percent)}</span>
                        </td>
                        <td class="py-3 px-1 text-center">
                            <button onclick="deletePosition(${parseInt(p.id)})" class="text-gray-500 hover:text-red-400 transition" title="Loeschen">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </td>
                    </tr>
                `).join('');

                // Mobile: Cards
                cardsContainer.innerHTML = positions.map(p => `
                    <div class="bg-gray-700/30 rounded-lg p-3 border-l-4 ${p.profit_loss_eur >= 0 ? 'border-green-500' : 'border-red-500'}">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="${metalColors[p.metal_type] || ''} font-medium text-base">${escapeHtml(metalNames[p.metal_type] || p.metal_type)}</h3>
                                <p class="text-gray-400 text-xs">${escapeHtml(spreadCategoryNames[p.spread_category] || productNames[p.product_type] || p.product_type)}${p.description ? ' · ' + escapeHtml(p.description) : ''}</p>
                                ${p.purchase_date ? `<p class="text-gray-500 text-xs mt-1">Gekauft: ${formatDate(p.purchase_date)}</p>` : ''}
                            </div>
                            <button onclick="deletePosition(${parseInt(p.id)})" class="text-gray-500 hover:text-red-400 transition p-1" title="Loeschen">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>
                                <p class="text-gray-500 text-xs">Menge</p>
                                <p>${parseInt(p.quantity)}x ${formatWeight(p.weight_per_unit, p.weight_unit)}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-gray-500 text-xs">Kaufpreis</p>
                                <p>${formatEUR(p.purchase_price_eur)}</p>
                            </div>
                            <div>
                                <p class="text-gray-500 text-xs">Ankaufswert</p>
                                <p class="font-medium">${formatEUR(p.current_value_eur)}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-gray-500 text-xs">Gewinn/Verlust</p>
                                <p class="${p.profit_loss_eur >= 0 ? 'positive' : 'negative'} font-medium">
                                    ${(p.profit_loss_eur >= 0 ? '+' : '') + formatEUR(p.profit_loss_eur)}
                                    <span class="text-xs opacity-75">(${formatPercent(p.profit_loss_percent)})</span>
                                </p>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Fehler beim Laden der Positionen:', e);
            }
        }

        async function loadHistory() {
            const days = document.getElementById('chart-period').value;
            try {
                const res = await apiFetch(API + '/api/history?days=' + days);
                if (!res || !res.ok) return;
                const data = await res.json();

                const chartEl = document.getElementById('history-chart');
                const noHistoryEl = document.getElementById('no-history');

                if (data.snapshots.length === 0) {
                    chartEl.style.display = 'none';
                    noHistoryEl.classList.remove('hidden');
                    return;
                }

                chartEl.style.display = 'block';
                noHistoryEl.classList.add('hidden');

                const labels = data.snapshots.map(s => formatDate(s.date));
                const values = data.snapshots.map(s => s.total_current_value_eur);
                const purchases = data.snapshots.map(s => s.total_purchase_value_eur);

                if (historyChart) historyChart.destroy();

                historyChart = new Chart(chartEl, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Aktueller Wert',
                                data: values,
                                borderColor: '#FFD700',
                                backgroundColor: 'rgba(255, 215, 0, 0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Kaufwert',
                                data: purchases,
                                borderColor: '#6B7280',
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top', labels: { color: '#9CA3AF', boxWidth: 12 } }
                        },
                        scales: {
                            x: { grid: { color: '#374151' }, ticks: { color: '#9CA3AF', maxRotation: 0 } },
                            y: { grid: { color: '#374151' }, ticks: { color: '#9CA3AF', callback: v => formatEUR(v) } }
                        }
                    }
                });
            } catch (e) {
                console.error('Fehler beim Laden der History:', e);
            }
        }

        async function addPosition(e) {
            e.preventDefault();

            const spreadValue = document.getElementById('spread-percent').value;
            const useCustomSpread = document.getElementById('use-custom-spread').checked;
            const spreadCategory = document.getElementById('spread-category').value;

            // Mappe spread_category zu product_type fuer Abwaertskompatibilitaet
            const categoryToProduct = {
                coin_bullion: 'coin', coin_numismatic: 'coin',
                bar_large: 'bar', bar_small: 'bar', bar_minted: 'bar',
                round: 'round', granulate: 'granulate', jewelry: 'jewelry'
            };

            const data = {
                metal_type: document.getElementById('metal-type').value,
                product_type: categoryToProduct[spreadCategory] || 'bar',
                spread_category: spreadCategory,
                description: document.getElementById('description').value || null,
                quantity: parseInt(document.getElementById('quantity').value) || 1,
                weight_per_unit: parseFloat(document.getElementById('weight').value),
                weight_unit: document.getElementById('weight-unit').value,
                purchase_price_eur: parseFloat(document.getElementById('purchase-price').value),
                purchase_date: document.getElementById('purchase-date').value || null,
                spread_percent: useCustomSpread && spreadValue ? parseFloat(spreadValue) : null
            };

            try {
                const res = await apiFetch(API + '/api/positions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!res) return;
                if (res.ok) {
                    document.getElementById('add-form').reset();
                    document.getElementById('weight-unit').value = 'oz';
                    document.getElementById('quantity').value = '1';
                    document.getElementById('weight').value = '1';
                    document.getElementById('spread-category').value = 'bar_large';
                    document.getElementById('use-custom-spread').checked = false;
                    document.getElementById('spread-percent').classList.add('hidden');
                    document.getElementById('spread-percent').value = '';
                    updateSpreadReference();
                    hideAddPositionModal();
                    loadAll();
                } else {
                    const err = await res.json();
                    if (res.status === 403) {
                        // Position-Limit erreicht
                        alert(err.detail || 'Position-Limit erreicht. Upgrade auf Premium!');
                    } else {
                        alert('Fehler: ' + (err.detail || 'Unbekannt'));
                    }
                }
            } catch (e) {
                console.error('Fehler:', e);
                alert('Fehler beim Hinzufügen');
            }
        }

        async function deletePosition(id) {
            if (!confirm('Position wirklich löschen?')) return;

            try {
                const res = await apiFetch(API + '/api/positions/' + id, { method: 'DELETE' });
                if (!res) return;
                if (res.ok) loadAll();
            } catch (e) {
                console.error('Fehler:', e);
            }
        }

        // === API KEYS ===

        function showCreateKeyModal() {
            document.getElementById('key-name-input').value = '';
            document.getElementById('create-key-modal').classList.remove('hidden');
            document.getElementById('key-name-input').focus();
        }

        function hideCreateKeyModal() {
            document.getElementById('create-key-modal').classList.add('hidden');
        }

        function hideShowKeyModal() {
            document.getElementById('show-key-modal').classList.add('hidden');
            loadApiKeys();
        }

        async function createApiKey() {
            const name = document.getElementById('key-name-input').value.trim();
            if (!name) {
                alert('Bitte gib einen Namen ein');
                return;
            }

            try {
                const res = await apiFetch(API + '/api/auth/api-keys', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name })
                });

                if (!res) return;

                if (res.ok) {
                    const data = await res.json();
                    hideCreateKeyModal();
                    // Zeige Key im Modal
                    document.getElementById('new-api-key').textContent = data.api_key;
                    document.getElementById('show-key-modal').classList.remove('hidden');
                } else {
                    const err = await res.json();
                    alert('Fehler: ' + (err.detail || 'Unbekannt'));
                }
            } catch (e) {
                console.error('Fehler:', e);
                alert('Fehler beim Erstellen des API-Keys');
            }
        }

        async function copyApiKey() {
            const key = document.getElementById('new-api-key').textContent;
            try {
                await navigator.clipboard.writeText(key);
                alert('API-Key kopiert!');
            } catch (e) {
                // Fallback
                const input = document.createElement('input');
                input.value = key;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                alert('API-Key kopiert!');
            }
        }

        async function loadApiKeys() {
            try {
                const res = await apiFetch(API + '/api/auth/api-keys');
                if (!res || !res.ok) return;

                const keys = await res.json();
                const container = document.getElementById('api-keys-list');

                if (keys.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-sm">Keine API-Keys vorhanden</p>';
                    return;
                }

                container.innerHTML = keys.map(k => `
                    <div class="flex items-center justify-between bg-gray-700/50 rounded p-3">
                        <div>
                            <span class="font-medium">${escapeHtml(k.name)}</span>
                            <code class="ml-2 text-xs text-gray-400 bg-gray-800 px-2 py-0.5 rounded">${escapeHtml(k.key_prefix)}...</code>
                        </div>
                        <div class="flex items-center gap-3 text-sm text-gray-400">
                            <span title="Erstellt">${formatDate(k.created_at)}</span>
                            ${k.last_used_at ? '<span class="text-green-500" title="Zuletzt verwendet">Aktiv</span>' : ''}
                            <button onclick="deleteApiKey(${k.id})" class="text-gray-500 hover:text-red-400 transition" title="Löschen">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Fehler beim Laden der API-Keys:', e);
            }
        }

        async function deleteApiKey(id) {
            if (!confirm('API-Key wirklich löschen?')) return;

            try {
                const res = await apiFetch(API + '/api/auth/api-keys/' + id, { method: 'DELETE' });
                if (!res) return;
                if (res.ok) loadApiKeys();
            } catch (e) {
                console.error('Fehler:', e);
            }
        }

        // === SETTINGS ===

        // === ADD POSITION MODAL ===
        function showAddPositionModal() {
            document.getElementById('add-position-modal').classList.remove('hidden');
            // Kein auto-focus auf Select-Elemente - verhindert ungewolltes Öffnen des Dropdowns
            document.getElementById('description').focus();
        }

        function hideAddPositionModal() {
            document.getElementById('add-position-modal').classList.add('hidden');
        }

        // === SETTINGS MODAL ===
        async function showSettingsModal() {
            toggleUserMenu(); // Menu schliessen
            showSettingsTab('discounts'); // Default Tab
            try {
                const res = await apiFetch(API + '/api/settings');
                if (!res) return;
                if (res.ok) {
                    const settings = await res.json();
                    // Neue kategorie-basierte Spreads laden
                    const spreads = settings.default_spreads || REFERENCE_SPREADS.gold;
                    const categories = ['coin_bullion', 'coin_numismatic', 'bar_large', 'bar_small', 'bar_minted', 'round', 'granulate', 'jewelry'];
                    categories.forEach(cat => {
                        const input = document.getElementById('spread-' + cat);
                        if (input) {
                            input.value = spreads[cat] ?? REFERENCE_SPREADS.gold[cat] ?? 0;
                        }
                    });
                    document.getElementById('settings-modal').classList.remove('hidden');
                }
            } catch (e) {
                console.error('Fehler beim Laden der Einstellungen:', e);
            }
        }

        function resetSpreadsToDefault() {
            const categories = ['coin_bullion', 'coin_numismatic', 'bar_large', 'bar_small', 'bar_minted', 'round', 'granulate', 'jewelry'];
            categories.forEach(cat => {
                const input = document.getElementById('spread-' + cat);
                if (input) {
                    input.value = REFERENCE_SPREADS.gold[cat] ?? 0;
                }
            });
        }

        function hideSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        function showSettingsTab(tab) {
            // Tabs
            document.getElementById('tab-discounts').classList.toggle('border-yellow-500', tab === 'discounts');
            document.getElementById('tab-discounts').classList.toggle('text-yellow-500', tab === 'discounts');
            document.getElementById('tab-discounts').classList.toggle('border-transparent', tab !== 'discounts');
            document.getElementById('tab-discounts').classList.toggle('text-gray-400', tab !== 'discounts');

            document.getElementById('tab-apikeys').classList.toggle('border-yellow-500', tab === 'apikeys');
            document.getElementById('tab-apikeys').classList.toggle('text-yellow-500', tab === 'apikeys');
            document.getElementById('tab-apikeys').classList.toggle('border-transparent', tab !== 'apikeys');
            document.getElementById('tab-apikeys').classList.toggle('text-gray-400', tab !== 'apikeys');

            // Content
            document.getElementById('settings-discounts').classList.toggle('hidden', tab !== 'discounts');
            document.getElementById('settings-apikeys').classList.toggle('hidden', tab !== 'apikeys');

            // Load API keys when switching to that tab
            if (tab === 'apikeys') {
                loadApiKeys();
            }
        }

        async function saveSettings() {
            // Kategorie-basierte Spreads sammeln
            const categories = ['coin_bullion', 'coin_numismatic', 'bar_large', 'bar_small', 'bar_minted', 'round', 'granulate', 'jewelry'];
            const default_spreads = {};
            categories.forEach(cat => {
                const input = document.getElementById('spread-' + cat);
                if (input) {
                    default_spreads[cat] = parseFloat(input.value) || REFERENCE_SPREADS.gold[cat] || 0;
                }
            });

            const data = {
                default_spreads: default_spreads,
                // Alte Felder fuer Abwaertskompatibilitaet (mit Gold-Werten)
                default_discount_gold: default_spreads.bar_large || 0,
                default_discount_silver: 0,
                default_discount_platinum: 0,
                default_discount_palladium: 0
            };

            try {
                const res = await apiFetch(API + '/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!res) return;
                if (res.ok) {
                    hideSettingsModal();
                    // Portfolio neu laden, da sich Werte geaendert haben koennten
                    loadAll();
                } else {
                    const err = await res.json();
                    alert('Fehler: ' + (err.detail || 'Unbekannt'));
                }
            } catch (e) {
                console.error('Fehler:', e);
                alert('Fehler beim Speichern');
            }
        }

        function loadAll() {
            loadUserInfo();
            loadPrices();
            loadSummary();
            loadPositions();
            loadHistory();
        }

        // Event Listeners
        document.getElementById('add-form').addEventListener('submit', addPosition);
        document.getElementById('chart-period').addEventListener('change', loadHistory);

        // Close modals with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideAddPositionModal();
                hideSettingsModal();
                hideCreateKeyModal();
                hideShowKeyModal();
            }
        });

        // Init - Check Auth first
        (function init() {
            // WICHTIG: Zuerst OAuth-Token aus URL pruefen (Google Callback)
            const urlParams = new URLSearchParams(window.location.search);
            const oauthToken = urlParams.get('token');
            if (oauthToken) {
                localStorage.setItem('metaltracker_token', oauthToken);
                // Clean URL und neu laden
                window.history.replaceState({}, document.title, '/');
            }

            // Dann localStorage pruefen
            const token = getToken();
            if (!token) {
                window.location.href = '/login.html';
                return;
            }

            loadAll();
        })();

        // Auto-refresh alle 5 Minuten
        setInterval(loadAll, 5 * 60 * 1000);
    </script>
</body>
</html>
